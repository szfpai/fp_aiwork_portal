Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _vue=require("vue"),_xeUtils=_interopRequireDefault(require("xe-utils")),_ui=require("../../ui"),_util=require("./util"),_dom=require("../../ui/src/dom"),_utils=require("../../ui/src/utils"),_vn=require("../../ui/src/vn");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}let{getI18n,renderer,renderEmptyElement}=_ui.VxeUI,renderType="body";var _default=exports.default=(0,_vue.defineComponent)({name:"VxeTableBody",props:{tableData:Array,tableColumn:Array,fixedColumn:Array,fixedType:{type:String,default:""}},setup(T){let Ge=(0,_vue.inject)("$xeTable",{}),{xID:z,props:We,context:$,reactData:Pe,internalData:Ve}=Ge,{computeEditOpts:Xe,computeMouseOpts:Ke,computeCellOffsetWidth:Ye,computeAreaOpts:Je,computeDefaultRowHeight:Qe,computeEmptyOpts:A,computeTooltipOpts:Ze,computeRadioOpts:e,computeExpandOpts:oe,computeTreeOpts:p,computeCheckboxOpts:el,computeCellOpts:ll,computeValidOpts:tl,computeRowOpts:al,computeColumnOpts:rl,computeRowDragOpts:ol,computeColumnDragOpts:l,computeResizableOpts:il,computeVirtualXOpts:sl,computeVirtualYOpts:dl}=Ge.getComputeMaps(),q=(0,_vue.ref)(),F=(0,_vue.ref)(),H=(0,_vue.ref)(),U=(0,_vue.ref)(),L=(0,_vue.ref)(),j=(0,_vue.ref)(),N=(0,_vue.ref)(),B=(0,_vue.ref)(),nl=()=>{var e=We.delayHover,{lastScrollTime:l,isDragResize:t}=Pe;return!!(t||l&&Date.now()<l+e)},ul=(e,l,t)=>{var{row:a,column:r}=l,o=Ve.afterFullData,i=We.treeConfig,s=p.value,{slots:r,treeNode:n}=r,d=Ve.fullAllDataRowIdData;if(r&&r.line)return Ge.callSlot(r.line,l);r=d[e];let u=0,c=null;return r&&(u=r.level,c=r.items[r.treeIndex-1]),i&&n&&(s.showLine||s.line)?[(0,_vue.h)("div",{key:"tl",class:"vxe-tree--line-wrapper"},[(0,_vue.h)("div",{class:"vxe-tree--line",style:{height:`${Ge.eqRow(o[0],a)?1:(0,_util.calcTreeLine)(l,c)}px`,bottom:`-${Math.floor(t/2)}px`,left:u*s.indent+(u?2-(0,_util.getOffsetSize)(Ge):0)+16+"px"}})])]:[]},se=(q,e,l,F,H,t,a,U,r,o,L,j,i)=>{var s=Ge.xeGrid,{columnKey:N,resizable:n,showOverflow:d,border:B,height:u,treeConfig:G,cellClassName:W,cellStyle:P,align:V,spanMethod:X,mouseConfig:K,editConfig:Y,editRules:c,tooltipConfig:p,padding:v}=We,{tableData:g,dragRow:J,overflowX:Q,currentColumn:Z,scrollXLoad:ee,scrollYLoad:x,mergeBodyFlag:le,calcCellHeightFlag:h,resizeHeightFlag:m,resizeWidthFlag:te,editStore:ae,isAllOverflow:re,validErrorMaps:w}=Pe,{fullAllDataRowIdData:f,fullColumnIdData:_,mergeBodyCellMaps:oe,visibleColumn:ie,afterFullData:se,mergeBodyList:ne,scrollXStore:de,scrollYStore:ue}=Ve,ce=ll.value,b=tl.value,pe=el.value,ve=Xe.value,y=Ze.value,ge=il.value,xe=sl.value,he=dl.value,{isAllColumnDrag:ge,isAllRowDrag:me}=ge,C=al.value,D=ol.value,we=Qe.value,h=h?ce.height||C.height:0,{disabledMethod:R,isCrossDrag:fe,isPeerDrag:_e}=D,be=rl.value,ye=Ke.value,Ce=Je.value,De=Ye.value,Ce=Ce.selectCellToRow,{type:Re,cellRender:Ee,editRender:Oe,align:Ie,showOverflow:Se,className:Me,treeNode:ke,rowResize:Te,padding:E,verticalAlign:O,slots:ze}=o,I=ce.verticalAlign,ae=ae.actived,f=f[e]||{},S=o.id,_=_[S]||{},M=Oe||Ee,M=M?renderer.get(M.name):null,$e=M?M.tableCellClassName||M.cellClassName:null,Ae=M?M.tableCellStyle||M.cellStyle:"";let qe=y.showAll;var Fe=_.index,y=_._index,_=(0,_utils.isEnableConf)(Oe),m=m?f.resizeHeight:0;let k=l?o.fixed!==l:o.fixed&&Q;Q=_xeUtils.default.eqNull(E)?null===v?ce.padding:v:E,v=_xeUtils.default.eqNull(Se)?d:Se,E="ellipsis"===v;let T="title"===v,z=!0===v||"tooltip"===v;d=re||T||z||E,Se=_xeUtils.default.isBoolean(o.resizable)?o.resizable:be.resizable||n,v=!!h,n=0<m;let He;h={},m=Ie||(M?M.tableCellAlign:"")||V,Ie=_xeUtils.default.eqNull(O)?I:O,M=w[e+":"+S],V=c&&b.showMessage&&("default"===b.message?u||1<g.length:"inline"===b.message),I={colid:S};let $={$table:Ge,$grid:s,isEdit:!1,seq:q,rowid:e,row:t,rowIndex:a,$rowIndex:U,_rowIndex:r,column:o,columnIndex:Fe,$columnIndex:L,_columnIndex:y,fixed:l,type:renderType,isHidden:!!k,level:H,visibleData:se,data:g,items:i},A=!1,Ue=!1,Le=((A=C.drag?"row"===D.trigger||o.dragSort&&"cell"===D.trigger:A)&&(Ue=!(!R||!R($))),(T||z||qe||p)&&(h.onMouseenter=e=>{nl()||(T?(0,_dom.updateCellTitle)(e.currentTarget,o):(z||qe)&&Ge.triggerBodyTooltipEvent(e,$),Ge.dispatchEvent("cell-mouseenter",Object.assign({cell:e.currentTarget},$),e))}),(z||qe||p)&&(h.onMouseleave=e=>{nl()||((z||qe)&&Ge.handleTargetLeaveEvent(e),Ge.dispatchEvent("cell-mouseleave",Object.assign({cell:e.currentTarget},$),e))}),(A||pe.range||K)&&(h.onMousedown=e=>{Ge.triggerCellMousedownEvent(e,$)}),A&&(h.onMouseup=Ge.triggerCellMouseupEvent),h.onClick=e=>{Ge.triggerCellClickEvent(e,$)},!(h.onDblclick=e=>{Ge.triggerCellDblclickEvent(e,$)}));if(le&&ne.length){O=oe[r+":"+y];if(O){var{rowspan:w,colspan:c}=O;if(!w||!c)return null;1<w&&(Le=!0,I.rowspan=w),1<c&&(Le=!0,I.colspan=c)}}else if(X){var{rowspan:u=1,colspan:s=1}=X($)||{};if(!u||!s)return null;1<u&&(I.rowspan=u),1<s&&(I.colspan=s)}!(k=k&&Le&&(1<I.colspan||1<I.rowspan)?!1:k)&&Y&&(Oe||Ee)&&(ve.showStatus||ve.showUpdateStatus)&&(He=Ge.isUpdateByRow(t,o.field));q=x&&!d,a=f.resizeHeight||ce.height||C.height||f.height||we,U=L===j.length-1,se=!o.resizeWidth&&("auto"===o.minWidth||"auto"===o.width);let je=!1;Le||J&&(0,_util.getRowid)(Ge,J)===e||(x&&!G&&!he.immediate&&(r<ue.visibleStartIndex-ue.preloadSize||r>ue.visibleEndIndex+ue.preloadSize)||ee&&!xe.immediate&&!o.fixed&&(y<de.visibleStartIndex-de.preloadSize||y>de.visibleEndIndex+de.preloadSize))&&(je=!0);g={};if(d&&te){let l=I.colspan||0;if(1<l)for(let e=1;e<l;e++){var Ne=ie[Fe+e];Ne&&(l+=Ne.renderWidth)}g.width=o.renderWidth-De*l+"px"}x||d||v||n?g.height=a+"px":g.minHeight=a+"px";i=[];k&&re?i.push((0,_vue.h)("div",{key:"tc",class:["vxe-cell",{"c--title":T,"c--tooltip":z,"c--ellipsis":E}],style:g})):(i.push(...ul(e,$,a),(0,_vue.h)("div",{key:"tc",class:["vxe-cell",{"c--title":T,"c--tooltip":z,"c--ellipsis":E}],style:g,title:T?Ge.getCellLabel(t,o):null},je?[]:[(0,_vue.h)("div",{colid:S,rowid:e,class:"vxe-cell--wrapper"},o.renderCell($))])),V&&M&&(D=M.rule,R=ze?ze.valid:null,p=Object.assign(Object.assign(Object.assign({},$),M),{rule:M}),i.push((0,_vue.h)("div",{key:"tcv",class:["vxe-cell--valid-error-tip",(0,_dom.getPropClass)(b.className,p)],style:D&&D.maxWidth?{width:D.maxWidth+"px"}:null},[(0,_vue.h)("div",{class:"vxe-cell--valid-error-wrapper vxe-cell--valid-error-theme-"+(b.theme||"normal")},[R?Ge.callSlot(R,p):[(0,_vue.h)("span",{class:"vxe-cell--valid-error-msg"},M.content)]])]))));let Be=!1;return K&&ye.area&&Ce&&((y||!0!==Ce)&&Ce!==o.field||(Be=!0)),!k&&Se&&ge&&i.push((0,_vue.h)("div",{key:"tcc",class:["vxe-cell--col-resizable",{"is--line":!B||"none"===B}],onMousedown:e=>Ge.handleColResizeMousedownEvent(e,l,$),onDblclick:e=>Ge.handleColResizeDblclickEvent(e,$)})),(Te||me)&&C.resizable&&i.push((0,_vue.h)("div",{key:"tcr",class:"vxe-cell--row-resizable",onMousedown:e=>Ge.handleRowResizeMousedownEvent(e,$),onDblclick:e=>Ge.handleRowResizeDblclickEvent(e,$)})),(0,_vue.h)("td",Object.assign(Object.assign(Object.assign({class:["vxe-body--column",S,Ie?"col--vertical-"+Ie:"",m?"col--"+m:"",Re?"col--"+Re:"",{"col--last":U,"col--tree-node":ke,"col--edit":_,"col--ellipsis":d,"col--cs-height":v,"col--rs-height":n,"col--to-row":Be,"col--auto-height":q,"fixed--width":!se,"fixed--hidden":k,"is--padding":Q,"is--progress":k&&re||je,"is--drag-cell":A&&(fe||_e||!H),"is--drag-disabled":Ue,"col--dirty":He,"col--active":Y&&_&&ae.row===t&&(ae.column===o||"row"===ve.mode),"col--valid-error":!!M,"col--current":Z===o},(0,_dom.getPropClass)($e,$),(0,_dom.getPropClass)(Me,$),(0,_dom.getPropClass)(W,$)],key:N||ee||x||be.useKey||C.useKey||be.drag?S:L},I),{style:Object.assign({},_xeUtils.default.isFunction(Ae)?Ae($):Ae,_xeUtils.default.isFunction(P)?P($):P)}),h),F&&k?[]:i)},ie=(h,m,w,f)=>{let _=Ge.xeGrid,{stripe:b,rowKey:y,highlightHoverRow:C,rowClassName:D,rowStyle:R,editConfig:E,treeConfig:O}=We,{hasFixedColumn:I,treeExpandedFlag:S,isColLoading:M,scrollXLoad:k,scrollYLoad:T,isAllOverflow:z,rowExpandedFlag:$,expandColumn:A,selectRadioRow:q,pendingRowFlag:F,isDragColMove:H,rowExpandHeightFlag:U,isRowGroupStatus:L}=Pe,{fullAllDataRowIdData:j,fullColumnIdData:N,treeExpandedMaps:B,pendingRowMaps:G,rowExpandedMaps:W}=Ve,Q=el.value,Z=e.value,P=p.value,V=Xe.value,X=al.value,K=rl.value,ee=l.value,{transform:Y,seqMode:le}=P,te=P.children||P.childrenField,J=[],ae=(0,_util.createHandleGetRowId)(Ge).handleGetRowId,re=O||L;return w.forEach((a,r)=>{let o=ae(a);var i=j[o]||{};let s=r,n=0,d=-1,u=-1;var c=L&&a.isAggregate,p={},v=((X.isHover||C)&&(p.onMouseenter=e=>{nl()||Ge.triggerHoverEvent(e,{row:a,rowIndex:s})},p.onMouseleave=()=>{nl()||Ge.clearHoverRow()}),i&&(n=i.level,d=c||O&&Y&&"increasing"===le?i._index+1:i.seq,s=i.index,u=i._index),{$table:Ge,seq:d,rowid:o,fixed:h,type:renderType,level:n,row:a,rowIndex:s,$rowIndex:r,_rowIndex:u}),g=A&&!!$&&!!W[o];let e=!1,l=[],t=!1;E&&(t=Ge.isInsertByRow(a)),!O||T||Y||(l=a[te],e=!!S&&l&&0<l.length&&!!B[o]),!X.drag||L||O&&!Y||(p.onDragstart=Ge.handleRowDragDragstartEvent,p.onDragend=Ge.handleRowDragDragendEvent,p.onDragover=Ge.handleRowDragDragoverEvent);c=["vxe-body--row",re?"row--level-"+n:"",{"row--stripe":b&&(u+1)%2==0,"is--new":t,"is--expand-row":g,"is--expand-tree":e,"row--new":t&&(V.showStatus||V.showInsertStatus),"row--radio":Z.highlight&&Ge.eqRow(q,a),"row--checked":Q.highlight&&Ge.isCheckedByCheckboxRow(a),"row--pending":!!F&&!!G[o],"row--group":c},(0,_dom.getPropClass)(D,v)];let x=f.map((e,l)=>se(d,o,h,m,n,a,s,r,u,e,l,f,w));if(J.push(!M&&K.drag&&ee.animation?(0,_vue.h)(_vue.TransitionGroup,Object.assign({name:"vxe-header--col-list"+(H?"":"-disabled"),tag:"tr",class:c,rowid:o,style:R?_xeUtils.default.isFunction(R)?R(v):R:null,key:y||k||T||X.useKey||X.drag||K.drag||L||O?o:r},p),{default:()=>x}):(0,_vue.h)("tr",Object.assign({class:c,rowid:o,style:R?_xeUtils.default.isFunction(R)?R(v):R:null,key:y||k||T||X.useKey||X.drag||K.drag||L||O?o:r},p),x)),g){var{height:c,padding:v,mode:p}=oe.value;if("fixed"===p)J.push((0,_vue.h)("tr",{class:"vxe-body--row-expanded-place",key:"expand_"+o,rowid:o},[(0,_vue.h)("td",{class:"vxe-body--row-expanded-place-column",colspan:f.length,style:{height:`${U?i.expandHeight||c:0}px`}})]));else{g={},p=(c&&(g.height=c+"px"),O&&(g.paddingLeft=n*P.indent+30+"px"),A||{}).showOverflow,i=A.id,i=N[i]||{},p=_xeUtils.default.isUndefined(p)||_xeUtils.default.isNull(p)?z:p;let e=-1,l=-1,t=-1;i&&(e=i.index,l=i.$index,t=i._index);i={$grid:_,$table:Ge,seq:d,column:A,columnIndex:e,$columnIndex:l,_columnIndex:t,fixed:h,type:renderType,level:n,row:a,rowid:o,rowIndex:s,$rowIndex:r,_rowIndex:u,isHidden:!1,isEdit:!1,visibleData:[],data:[],items:[]};J.push((0,_vue.h)("tr",{class:["vxe-body--expanded-row",{"is--padding":v}],key:"expand_"+o},[(0,_vue.h)("td",{class:["vxe-body--expanded-column",{"fixed--hidden":h&&!I,"col--ellipsis":p}],colspan:f.length},[(0,_vue.h)("div",{class:["vxe-body--expanded-cell",{"is--ellipsis":c}],style:g},[A.renderData(i)])])]))}}e&&J.push(...ie(h,m,l,f))}),J};(0,_vue.onMounted)(()=>{(0,_vue.nextTick)(()=>{var e=T.fixedType,l=Ve.elemStore,e=`${e||"main"}-body-`;l[e+"wrapper"]=q,l[e+"scroll"]=F,l[e+"table"]=H,l[e+"colgroup"]=U,l[e+"list"]=L,l[e+"xSpace"]=j,l[e+"ySpace"]=N,l[e+"emptyBlock"]=B})}),(0,_vue.onUnmounted)(()=>{var e=T.fixedType,l=Ve.elemStore,e=`${e||"main"}-body-`;l[e+"wrapper"]=null,l[e+"scroll"]=null,l[e+"table"]=null,l[e+"colgroup"]=null,l[e+"list"]=null,l[e+"xSpace"]=null,l[e+"ySpace"]=null,l[e+"emptyBlock"]=null});return()=>{var e=$.slots,l=Ge.xeGrid;let{fixedColumn:t,fixedType:a,tableColumn:r}=T;var{spanMethod:o,footerSpanMethod:i,mouseConfig:s}=We,{isGroup:n,tableData:d,isRowLoading:u,isColLoading:c,overflowX:p,scrollXLoad:v,scrollYLoad:g,isAllOverflow:x,isDragRowMove:h,expandColumn:m,dragRow:w,dragCol:f}=Pe,{visibleColumn:_,fullAllDataRowIdData:b,fullColumnIdData:y}=Ve,C=al.value,D=A.value,R=Ke.value,E=ol.value,O=oe.value;let I=d,S=r,M=!1;!(v||g||x)||m&&"fixed"!==O.mode||o||i||(M=!0),c||!a&&p||(S=_),a&&M&&(S=t||[]),g&&w&&2<I.length&&(d=b[(0,_util.getRowid)(Ge,w)])&&(x=d._index,m=I[0],O=I[I.length-1],o=b[(0,_util.getRowid)(Ge,m)],i=b[(0,_util.getRowid)(Ge,O)],o)&&i&&(p=o._index,_=i._index,x<p?I=[w].concat(I):_<x&&(I=I.concat([w]))),a||n||v&&f&&2<S.length&&(g=y[f.id])&&(d=g._index,m=S[0],b=S[S.length-1],O=y[m.id],o=y[b.id],O)&&o&&(i=O._index,p=o._index,d<i?S=[f].concat(S):p<d&&(S=S.concat([f])));let k;_=e?e.empty:null,k=_?Ge.callSlot(_,{$table:Ge,$grid:l}):(w=(x=D.name?renderer.get(D.name):null)?x.renderTableEmpty||x.renderTableEmptyView||x.renderEmpty:null)?(0,_vn.getSlotVNs)(w(D,{$table:Ge})):We.emptyText||getI18n("vxe.table.emptyText"),n={onScroll(e){Ge.triggerBodyScrollEvent(e,a)}};return(0,_vue.h)("div",{ref:q,class:["vxe-table--body-wrapper",a?`fixed-${a}--wrapper`:"body--wrapper"],xid:z},[(0,_vue.h)("div",Object.assign({ref:F,class:"vxe-table--body-inner-wrapper"},n),[a?renderEmptyElement(Ge):(0,_vue.h)("div",{ref:j,class:"vxe-body--x-space"}),(0,_vue.h)("div",{ref:N,class:"vxe-body--y-space"}),(0,_vue.h)("table",{ref:H,class:"vxe-table--body",xid:z,cellspacing:0,cellpadding:0,border:0},[(0,_vue.h)("colgroup",{ref:U},S.map((e,l)=>(0,_vue.h)("col",{name:e.id,key:l,style:{width:e.renderWidth+"px"}}))),!u&&!c&&C.drag&&E.animation?(0,_vue.h)(_vue.TransitionGroup,{ref:L,name:"vxe-body--row-list"+(h?"":"-disabled"),tag:"tbody"},{default:()=>ie(a,M,I,S)}):(0,_vue.h)("tbody",{ref:L},ie(a,M,I,S))]),(0,_vue.h)("div",{class:"vxe-table--checkbox-range"}),s&&R.area?(0,_vue.h)("div",{class:"vxe-table--cell-area"},[(0,_vue.h)("span",{class:"vxe-table--cell-main-area"},R.extension?[(0,_vue.h)("span",{class:"vxe-table--cell-main-area-btn",onMousedown(e){Ge.triggerCellAreaExtendMousedownEvent&&Ge.triggerCellAreaExtendMousedownEvent(e,{$table:Ge,fixed:a,type:renderType})}})]:[]),(0,_vue.h)("span",{class:"vxe-table--cell-copy-area"}),(0,_vue.h)("span",{class:"vxe-table--cell-extend-area"}),(0,_vue.h)("span",{class:"vxe-table--cell-multi-area"}),(0,_vue.h)("span",{class:"vxe-table--cell-active-area"}),(0,_vue.h)("span",{class:"vxe-table--cell-row-status-area"})]):renderEmptyElement(Ge),a?renderEmptyElement(Ge):(0,_vue.h)("div",{class:"vxe-table--empty-block",ref:B},[(0,_vue.h)("div",{class:"vxe-table--empty-content"},k)])])])}}});