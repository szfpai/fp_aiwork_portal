var _vue=require("vue"),_ui=require("../../../ui"),_xeUtils=_interopRequireDefault(require("xe-utils"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}let tableCustomMethodKeys=["openCustom","closeCustom","saveCustom","cancelCustom","resetCustom","toggleCustomAllCheckbox","setCustomAllCheckbox"];_ui.VxeUI.hooks.add("tableCustomModule",{setupTable(d){let{reactData:m,internalData:s}=d,c=d.getComputeMaps().computeCustomOpts,i=d.getRefMaps().refElem,l=d.xeGrid,r=()=>{var e=m.customStore,t=i.value;let l=0;t&&(l=t.clientHeight-28),e.maxHeight=Math.max(88,l)},o=()=>{var{initStore:e,customStore:t}=m;return t.visible=!0,e.custom=!0,u(),n(),r(),(0,_vue.nextTick)().then(()=>r())},u=()=>{var e=m.customStore,t=s.collectColumn;if(e.visible){let l={},i={},s={};_xeUtils.default.eachTree(t,e=>{var t=e.getKey();e.renderFixed=e.fixed,e.renderVisible=e.visible,e.renderResizeWidth=e.renderWidth,l[t]=e.renderSortNumber,i[t]=e.fixed,s[t]=e.visible}),e.oldSortMaps=l,e.oldFixedMaps=i,e.oldVisibleMaps=s,m.customColumnList=t.slice(0)}},a=()=>{var e=m.customStore,t=c.value;return e.visible&&(e.visible=!1,t.immediate||d.handleCustom()),(0,_vue.nextTick)()};let t=e=>{var t=m.customStore,l=m.customColumnList,i=c.value;let{checkMethod:s,visibleMethod:r}=i,o=!!e;return i.immediate?(_xeUtils.default.eachTree(l,e=>{r&&!r({$table:d,column:e})||s&&!s({$table:d,column:e})||(e.visible=o,e.renderVisible=o,e.halfVisible=!1)}),t.isAll=o,m.isCustomStatus=!0,d.handleCustom(),d.saveCustomStore("update:visible")):(_xeUtils.default.eachTree(l,e=>{r&&!r({$table:d,column:e})||s&&!s({$table:d,column:e})||(e.renderVisible=o,e.halfVisible=!1)}),t.isAll=o),d.checkCustomStatus(),(0,_vue.nextTick)()};var e={openCustom:o,closeCustom:a,saveCustom:()=>{var e=m.customColumnList;let{allowVisible:r,allowSort:o,allowFixed:u,allowResizable:a}=c.value;return _xeUtils.default.eachTree(e,(e,t,l,i,s)=>{s?e.fixed=s.fixed:(o&&(e.renderSortNumber=t+1),u&&(e.fixed=e.renderFixed)),a&&e.renderVisible&&(!e.children||e.children.length)&&e.renderResizeWidth!==e.renderWidth&&(e.resizeWidth=e.renderResizeWidth,e.renderWidth=e.renderResizeWidth),r&&(e.visible=e.renderVisible)}),m.isCustomStatus=!0,m.isDragColMove=!0,setTimeout(()=>{m.isDragColMove=!1},1e3),d.saveCustomStore("confirm")},cancelCustom:()=>{var{customColumnList:e,customStore:t}=m;let{oldSortMaps:s,oldFixedMaps:r,oldVisibleMaps:o}=t,{allowVisible:u,allowSort:a,allowFixed:d,allowResizable:n}=c.value;return _xeUtils.default.eachTree(e,e=>{var t=e.getKey(),l=!!o[t],i=r[t]||"";u&&(e.renderVisible=l,e.visible=l),d&&(e.renderFixed=i,e.fixed=i),a&&(e.renderSortNumber=s[t]||0),n&&(e.renderResizeWidth=e.renderWidth)},{children:"children"}),(0,_vue.nextTick)()},resetCustom(e){var t=s.collectColumn;let l=c.value.checkMethod,i=Object.assign({visible:!0,resizable:!0===e,fixed:!0===e,sort:!0===e},e);return _xeUtils.default.eachTree(t,e=>{i.resizable&&(e.resizeWidth=0),i.fixed&&(e.fixed=e.defaultFixed),i.sort&&(e.renderSortNumber=e.sortNumber),l&&!l({$table:d,column:e})||(e.visible=e.defaultVisible),e.renderResizeWidth=e.renderWidth}),m.isCustomStatus=!1,d.saveCustomStore("reset"),d.handleCustom()},toggleCustomAllCheckbox(){var e=m.customStore,e=!e.isAll;return t(e)},setCustomAllCheckbox:t};let n=()=>{var e=m.customStore,t=s.collectColumn;let l=c.value.checkMethod;e.isAll=t.every(e=>!!l&&!l({$table:d,column:e})||e.renderVisible),e.isIndeterminate=!e.isAll&&t.some(e=>(!l||l({$table:d,column:e}))&&(e.renderVisible||e.halfVisible))},v=(e,t)=>{(l||d).dispatchEvent("custom",{type:e},t)};var b={checkCustomStatus:n,emitCustomEvent:v,triggerCustomEvent(e){var t=d.reactData.customStore;t.visible?(a(),v("close",e)):(t.btnEl=e.target,o(),v("open",e))},customOpenEvent(e){var t=d.reactData.customStore;t.visible||(t.activeBtn=!0,t.btnEl=e.target,d.openCustom(),d.emitCustomEvent("open",e))},customCloseEvent(e){var t=d.reactData.customStore;t.visible&&(t.activeBtn=!1,d.closeCustom(),d.emitCustomEvent("close",e))},handleUpdateCustomColumn:u};return Object.assign(Object.assign({},e),b)},setupGrid(e){return e.extendTableMethods(tableCustomMethodKeys)}});