"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _vue=require("vue"),_xeUtils=_interopRequireDefault(require("xe-utils")),_ui=require("../../ui"),_utils=require("../../ui/src/utils"),_dom=require("../../ui/src/dom"),_vn=require("../../ui/src/vn"),_util=require("./util");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var _default=exports.default=(0,_vue.defineComponent)({name:"VxeNumberInput",props:{modelValue:[String,Number],immediate:{type:Boolean,default:!0},name:String,type:{type:String,default:"number"},clearable:{type:Boolean,default:()=>(0,_ui.getConfig)().numberInput.clearable},readonly:{type:Boolean,default:null},disabled:{type:Boolean,default:null},placeholder:String,maxLength:{type:[String,Number],default:()=>(0,_ui.getConfig)().numberInput.maxLength},autoComplete:{type:String,default:"off"},align:String,form:String,className:String,size:{type:String,default:()=>(0,_ui.getConfig)().numberInput.size||(0,_ui.getConfig)().size},min:{type:[String,Number],default:null},max:{type:[String,Number],default:null},step:[String,Number],exponential:{type:Boolean,default:()=>(0,_ui.getConfig)().numberInput.exponential},showCurrency:{type:Boolean,default:()=>(0,_ui.getConfig)().numberInput.showCurrency},currencySymbol:{type:String,default:()=>(0,_ui.getConfig)().numberInput.currencySymbol},controlConfig:Object,digits:{type:[String,Number],default:null},autoFill:{type:Boolean,default:()=>(0,_ui.getConfig)().numberInput.autoFill},editable:{type:Boolean,default:!0},plusIcon:String,minusIcon:String,prefixIcon:String,suffixIcon:String,controls:{type:Boolean,default:null},maxlength:[String,Number],autocomplete:String},emits:["update:modelValue","input","change","keydown","keyup","wheel","click","focus","blur","clear","plus-number","minus-number","prefix-click","suffix-click","prev-number","next-number"],setup(b,e){const{slots:g,emit:i}=e,a=(0,_vue.inject)("$xeForm",null),n=(0,_vue.inject)("xeFormItemInfo",null);var u=_xeUtils.default.uniqueId();const K=(0,_ui.useSize)(b)["computeSize"],x=(0,_vue.reactive)({isFocus:!1,isActivated:!1,inputValue:b.modelValue}),r={},y=(0,_vue.ref)(),p=(0,_vue.ref)(),O=(0,_vue.ref)(),E=(0,_vue.computed)(()=>{var e=b["readonly"];return null===e?!!a&&a.props.readonly:e}),h=(0,_vue.computed)(()=>{var e=b["disabled"];return null===e?!!a&&a.props.disabled:e}),o=(0,_vue.computed)(()=>{var{type:e,digits:u}=b;let t=u;return null===t&&null===(t=(0,_ui.getConfig)().numberInput.digits)&&"amount"===e&&(t=2),_xeUtils.default.toInteger(t)||1}),N=(0,_vue.computed)(()=>Object.assign({},(0,_ui.getConfig)().numberInput.controlConfig,b.controlConfig)),s=(0,_vue.computed)(()=>{var e=b["type"];return"float"===e||"amount"===e}),q=(0,_vue.computed)(()=>{var e=b["type"],u=o.value,t=s.value,l=b.step;return"integer"===e?_xeUtils.default.toInteger(l)||1:t?_xeUtils.default.toNumber(l)||1/Math.pow(10,u):_xeUtils.default.toNumber(l)||1}),V=(0,_vue.computed)(()=>b.clearable),U=(0,_vue.computed)(()=>{var e=b["editable"];return E.value||!e}),R=(0,_vue.computed)(()=>{var e=b["placeholder"];return(e=e||(0,_ui.getConfig)().numberInput.placeholder)?(0,_utils.getFuncText)(e):(0,_ui.getI18n)("vxe.base.pleaseInput")}),d=(0,_vue.computed)(()=>{var{maxLength:e,maxlength:u}=b;return _xeUtils.default.toNumber(e||u)||16}),v=(0,_vue.computed)(()=>{var e=b["immediate"];return e}),l=(0,_vue.computed)(()=>{var e=b["type"],u=x["inputValue"];return"integer"===e?_xeUtils.default.toInteger((0,_util.handleNumber)(u)):_xeUtils.default.toNumber((0,_util.handleNumber)(u))}),I=(0,_vue.computed)(()=>{var{type:u,showCurrency:t,currencySymbol:l,autoFill:i}=b,a=x["inputValue"],n=o.value;if("amount"!==u)return _xeUtils.default.toString(a);{var u=_xeUtils.default.toNumber(a);let e=_xeUtils.default.commafy(u,{digits:n});return i||([a,u]=e.split("."),u&&(n=u.replace(/0+$/,""),e=n?[a,".",n].join(""):a)),t?""+(l||(0,_ui.getI18n)("vxe.numberInput.currencySymbol")||"")+e:e}}),c=(0,_vue.computed)(()=>{var e=b["min"],u=x["inputValue"],t=l.value;return!(!u&&0!==u||null===e)&&t<=_xeUtils.default.toNumber(e)}),m=(0,_vue.computed)(()=>{var e=b["max"],u=x["inputValue"],t=l.value;return!(!u&&0!==u||null===e)&&t>=_xeUtils.default.toNumber(e)}),D={refElem:y,refInput:p},P={computeControlOpts:N},_={xID:u,props:b,context:e,reactData:x,internalData:r,getRefMaps:()=>D,getComputeMaps:()=>P};let f={};const C=e=>_xeUtils.default.eqNull(e)?"":""+e,S=e=>{var{exponential:u,autoFill:t}=b,l=d.value,i=o.value;let a="";return s.value?(a=(0,_util.toFloatValueFixed)(e,i),t||(a=C(_xeUtils.default.toNumber(a)))):a=C(e),!u||e!==a&&C(e).toLowerCase()!==_xeUtils.default.toNumber(a).toExponential()?a.slice(0,l):e},T=e=>{var u=x["inputValue"];f.dispatchEvent(e.type,{value:u},e)},A=(e,u,t)=>{var e=(0,_utils.eqEmptyValue)(e)?null:Number(e),l=e!==b.modelValue;l&&(r.isUM=!0,i("update:modelValue",e)),x.inputValue!==u&&(0,_vue.nextTick)(()=>{x.inputValue=u||""}),f.dispatchEvent("input",{value:e},t),l&&(f.dispatchEvent("change",{value:e},t),a)&&n&&a.triggerItemEvent(t,n.itemConfig.field,e)},k=(e,u)=>{var t=v.value,l=(0,_utils.eqEmptyValue)(e)?null:_xeUtils.default.toNumber(e);x.inputValue=e,t?A(l,e,u):f.dispatchEvent("input",{value:l},u)},Y=e=>{var u=e.target.value;k(u,e)},j=e=>{v.value||T(e)},G=e=>{var u;U.value||(u=x["inputValue"],x.inputValue=(0,_utils.eqEmptyValue)(u)?"":""+_xeUtils.default.toNumber(u),x.isFocus=!0,x.isActivated=!0,T(e))},W=e=>{var u;h.value||(u=x["inputValue"],f.dispatchEvent("prefix-click",{value:u},e))},B=(e,u)=>{focus(),A(null,"",e),f.dispatchEvent("clear",{value:u},e)},z=e=>{var u;h.value||(u=x["inputValue"],f.dispatchEvent("suffix-click",{value:u},e))},$=()=>{var t=b["autoFill"],l=x["inputValue"],i=o.value,e=s.value;if(e&&l){let e="",u=null;l&&(e=(0,_util.toFloatValueFixed)(l,i),u=_xeUtils.default.toNumber(e),t||(e=""+u)),l!==u?A(u,e,{type:"init"}):x.inputValue=e}},H=e=>null===b.max||_xeUtils.default.toNumber(e)<=_xeUtils.default.toNumber(b.max),J=e=>null===b.min||_xeUtils.default.toNumber(e)>=_xeUtils.default.toNumber(b.min),w=()=>{var{type:u,min:t,max:l,exponential:i}=b,a=x["inputValue"];if(!U.value)if((0,_utils.eqEmptyValue)(a)){let e=null,u=a;!t&&0!==t||(e=_xeUtils.default.toNumber(t),u=""+e),void A(e,""+(u||""),{type:"check"})}else if(a||t||l){let e="integer"===u?_xeUtils.default.toInteger((0,_util.handleNumber)(a)):_xeUtils.default.toNumber((0,_util.handleNumber)(a));J(e)?H(e)||(e=l):e=t,i&&(u=C(a).toLowerCase())===_xeUtils.default.toNumber(e).toExponential()&&(e=u);l=S(e);A((0,_utils.eqEmptyValue)(l)?null:Number(l),l,{type:"check"})}},Q=e=>{var u=x["inputValue"],t=v.value,l=u?Number(u):null;t||A(l,C(u),e),w(),x.isFocus=!1,x.isActivated=!1,f.dispatchEvent("blur",{value:l},e),a&&n&&a.triggerItemEvent(e,n.itemConfig.field,l)},X=(e,u)=>{var{min:t,max:l,type:i}=b,a=x["inputValue"],n=q.value,i="integer"===i?_xeUtils.default.toInteger((0,_util.handleNumber)(a)):_xeUtils.default.toNumber((0,_util.handleNumber)(a)),a=e?_xeUtils.default.add(i,n):_xeUtils.default.subtract(i,n);let r;r=J(a)?H(a)?a:l:t,k(S(r),u)},L=e=>{var u=h.value,t=E.value,l=m.value;u||t||l||X(!0,e),x.isActivated=!0,f.dispatchEvent("plus-number",{value:x.inputValue},e),f.dispatchEvent("next-number",{value:x.inputValue},e)},M=e=>{var u=h.value,t=E.value,l=c.value;u||t||l||X(!1,e),x.isActivated=!0,f.dispatchEvent("minus-number",{value:x.inputValue},e),f.dispatchEvent("prev-number",{value:x.inputValue},e)},Z=e=>{var{type:u,exponential:t,controls:l}=b,i=N.value,a=i["showButton"],n=U.value,r=(0,_dom.hasControlKey)(e),o=e.shiftKey,s=e.altKey,v=e.keyCode,p=_ui.globalEvents.hasKey(e,_ui.GLOBAL_EVENT_KEYS.ESCAPE),d=_ui.globalEvents.hasKey(e,_ui.GLOBAL_EVENT_KEYS.ARROW_UP),c=_ui.globalEvents.hasKey(e,_ui.GLOBAL_EVENT_KEYS.ARROW_DOWN);r||o||s||(_ui.globalEvents.hasKey(e,_ui.GLOBAL_EVENT_KEYS.SPACEBAR)||"integer"===u&&110===v||(!t||69!==v)&&65<=v&&v<=90||186<=v&&v<=188||191<=v)&&e.preventDefault(),p?w():(d||c)&&(0,_utils.isEnableConf)(i)&&(!1===l?l:a)&&!n&&(r=e,o=_ui.globalEvents.hasKey(r,_ui.GLOBAL_EVENT_KEYS.ARROW_UP),s=_ui.globalEvents.hasKey(r,_ui.GLOBAL_EVENT_KEYS.ARROW_DOWN),o||s)&&(r.preventDefault(),(o?M:L)(r)),T(e)},ee=e=>{T(e)},ue=e=>{t(),r.ainTimeout=setTimeout(()=>{M(e),ue(e)},60)},te=e=>{t(),r.ainTimeout=setTimeout(()=>{L(e),te(e)},60)},t=()=>{var e;(e=r.dnTimeout)&&(clearTimeout(e),r.dnTimeout=void 0),(e=r.ainTimeout)&&(clearTimeout(e),r.ainTimeout=void 0)},le=e=>{r.isMouseDown?r.isMouseDown=!1:(t(),((0,_dom.hasClass)(e.currentTarget,"is--plus")?L:M)(e))},ie=e=>{if(t(),r.isMouseDown=!0,0===e.button){const u=(0,_dom.hasClass)(e.currentTarget,"is--plus");(u?L:M)(e),r.dnTimeout=setTimeout(()=>{(u?te:ue)(e)},500)}},ae=e=>{var u=b["controls"],t=N.value,l=t["isWheel"],i=U.value;(0,_utils.isEnableConf)(t)&&(!1===u?u:l)&&!i&&x.isActivated&&(e.stopPropagation(),e.preventDefault(),0<(t=e.deltaY)?L(e):t<0&&M(e)),T(e)},ne=e=>{T(e)},re=e=>{var u=x["isActivated"],t=y.value,l=O.value,i=h.value,a=U.value,n=v.value;i||a||!u||(x.isActivated=(0,_dom.getEventTargetNode)(e,t).flag||(0,_dom.getEventTargetNode)(e,l).flag,x.isActivated)||(n||(i=x["inputValue"],a=i?Number(i):null,A(a,C(i),e)),w())},oe=u=>{var t=b["clearable"],l=h.value,i=U.value;if(!l&&!i){l=_ui.globalEvents.hasKey(u,_ui.GLOBAL_EVENT_KEYS.TAB),i=_ui.globalEvents.hasKey(u,_ui.GLOBAL_EVENT_KEYS.DELETE);let e=x.isActivated;l&&(e&&w(),e=!1,x.isActivated=e),i&&t&&e&&B(u,null)}},se=()=>{var e=x["isActivated"];e&&w()};f={dispatchEvent:(e,u,t)=>{i(e,(0,_ui.createEvent)(t,{$numberInput:_},u))},focus(){var e;return U.value||(e=p.value,x.isActivated=!0,e.focus()),(0,_vue.nextTick)()},blur(){return p.value.blur(),(x.isActivated=!1,_vue.nextTick)()},select(){return p.value.select(),(x.isActivated=!1,_vue.nextTick)()}},Object.assign(_,f);const ve=()=>{var e=b["prefixIcon"],u=g.prefix;return u||e?(0,_vue.h)("div",{class:"vxe-number-input--prefix",onClick:W},[(0,_vue.h)("div",{class:"vxe-number-input--prefix-icon"},u?(0,_vn.getSlotVNs)(u({})):[(0,_vue.h)("i",{class:e})])]):(0,_ui.renderEmptyElement)(_)},pe=()=>{var e=b["suffixIcon"],u=x["inputValue"],t=g.suffix,l=h.value,i=V.value;return(0,_vue.h)("div",{class:["vxe-number-input--suffix",{"is--clear":i&&!l&&!(""===u||_xeUtils.default.eqNull(u))}]},[i?(0,_vue.h)("div",{class:"vxe-number-input--clear-icon",onClick:B},[(0,_vue.h)("i",{class:(0,_ui.getIcon)().INPUT_CLEAR})]):(0,_ui.renderEmptyElement)(_),t||e?(0,_vue.h)("div",{class:"vxe-number-input--suffix-icon",onClick:z},t?(0,_vn.getSlotVNs)(t({})):[(0,_vue.h)("i",{class:e})]):(0,_ui.renderEmptyElement)(_)])},F=()=>{var{type:e,name:u,autocomplete:t,autoComplete:l}=b,{inputValue:i,isFocus:a}=x,n=h.value,r=I.value,o=U.value,s=d.value,v=R.value;return(0,_vue.h)("div",{key:"ni",class:"vxe-number-input--input-wrapper"},[ve(),(0,_vue.h)("div",{class:"vxe-number-input--input-inner"},[(0,_vue.h)("input",{ref:p,class:"vxe-number-input--input",value:a||"amount"!==e?i:r,name:u,type:"text",placeholder:v,maxlength:s,readonly:o,disabled:n,autocomplete:l||t,onKeydown:Z,onKeyup:ee,onWheel:ae,onClick:ne,onInput:Y,onChange:j,onFocus:G,onBlur:Q})]),pe()])},de=()=>{var e=b["minusIcon"],u=c.value;return(0,_vue.h)("button",{key:"prev",class:["vxe-number-input--minus-btn is--minus",{"is--disabled":u}],onClick:le,onMousedown:ie,onMouseup:t,onMouseleave:t},[(0,_vue.h)("i",{class:e||(0,_ui.getIcon)().NUMBER_INPUT_MINUS_NUM})])},ce=()=>{var e=b["plusIcon"],u=m.value;return(0,_vue.h)("button",{key:"next",class:["vxe-number-input--plus-btn is--plus",{"is--disabled":u}],onClick:le,onMousedown:ie,onMouseup:t,onMouseleave:t},[(0,_vue.h)("i",{class:e||(0,_ui.getIcon)().NUMBER_INPUT_PLUS_NUM})])},me=()=>(0,_vue.h)("div",{key:"cplr",class:"vxe-number-input--side-control"},[ce(),de()]);return _.renderVN=()=>{var{className:e,controls:u,type:t,align:l,prefixIcon:i,suffixIcon:a}=b,{inputValue:n,isActivated:r}=x,o=K.value,s=N.value,{layout:v,showButton:p}=s,d=h.value,c=E.value,m=I.value,_=g.prefix,f=g.suffix;return c?(0,_vue.h)("div",{ref:y,class:["vxe-number-input--readonly","type--"+t,e]},m):(c=U.value,m=V.value,s=(0,_utils.isEnableConf)(s)&&(!1===u?u:p),(0,_vue.h)("div",{ref:y,class:["vxe-number-input","type--"+t,"control-"+("right"===v||"left"===v?v:"default"),e,{["size--"+o]:o,["is--"+l]:l,"is--controls":s&&!c,"is--prefix":!!_||i,"is--suffix":!!f||a,"is--disabled":d,"is--active":r,"show--clear":m&&!d&&!(""===n||_xeUtils.default.eqNull(n))}],spellcheck:!1},s?"right"===v?[F(),me()]:"left"===v?[me(),F()]:[de(),F(),ce()]:[F()]))},(0,_vue.watch)(()=>b.modelValue,u=>{if(!r.isUM){var t=b["autoFill"],l=x["inputValue"],i=o.value,a=s.value;if((0,_utils.eqEmptyValue)(u))x.inputValue="";else{let e=""+u;a&&(e=(0,_util.toFloatValueFixed)(u,i),t||(e=""+_xeUtils.default.toNumber(e))),e!==l&&(x.inputValue=e)}}r.isUM=!1}),(0,_vue.watch)(()=>b.type,()=>{Object.assign(x,{inputValue:b.modelValue}),$()}),(0,_vue.onMounted)(()=>{_ui.globalEvents.on(_,"mousedown",re),_ui.globalEvents.on(_,"keydown",oe),_ui.globalEvents.on(_,"blur",se)}),(0,_vue.onBeforeUnmount)(()=>{x.isFocus=!1,t(),w(),_ui.globalEvents.off(_,"mousedown"),_ui.globalEvents.off(_,"keydown"),_ui.globalEvents.off(_,"blur")}),$(),_},render(){return this.renderVN()}});